#!/bin/sh

if [ "$#" -lt "2" ]
then
	echo "USAGE: $0 <directory> <percentile> []"
	exit 1
fi

class=""
if [ "$#" -eq "3" ]
then
	class="$3"
fi

percentile="$2"
filename="$1_$percentile"
if [ -n "$class" ]
then
	filename="$filename-$class"
fi
filename="$filename.csv"

script="s|.*$percentile%\s\+||p"
wrapper="LD_PRELOAD=figures/libsi_us.so"
if [ "$percentile" = "tput" ]
then
	script="s|^Requests/sec:\s\+||p"
	wrapper=""
fi

if [ ! -e "$filename" ]
then
	eval export "$wrapper" >/dev/null
	figures/log2csv -s "baseline$class,preempt$class" -n "$script" "$1"/*.log >"$filename"
fi

figures/linegraph graph.png <"$filename"
